\subsection{Agenten}
Oberhalb des AgentRTE sind die Agenten implementiert. Sie bilden die oberste Ebene des Systems und implementieren die eigentliche Funktionalität. Dabei greifen sie auf das AgentenRTE und die verschiedenen Interfaces zu und kommunizieren untereinander über Agenten-Nachrichten. Auf jedem Modul agieren ein Plattform-Agent, der die Sensoren und Aktoren der Plattform steuert, ein Order-Agent, der zusammen mit anderen Order-Agenten die Betriebslogik des Materialflusssystems darstellt, ein Routing-Agent, der gemeinsam mit anderen Routing-Agenten die Pakete durch das System leitet und eventuell bis zu vier Paket-Agenten, die die physischen Pakete repräsentieren und durch das System wandern. Die einzelnen Agenten sind im Folgenden beschrieben.
\subsubsection{Paket-Agent}
Ein Paket-Agent repräsentiert ein physisches Paket. Seine ID ist gleichzeitig auch Paketnummer. Beim Eintritt in das System wird vom Plattform-Agenten ein neuer Paket-Agent initialisiert. Wechselt ein Paket von einem Modul auf das nächste, so wandert auch der Paket-Agent auf das neue Modul. Dies wird erreicht, indem der Agent auf dem einen Modul beendet und auf dem nächsten mit seinem Ziel und seiner ID neu initialisiert wird. Dies ist möglich, da sich verschiedene Pakete nur durch ihr Ziel und ihre ID voneinander unterscheiden. Die Übertragung der Paket-Agenten wird von den Plattform-Agenten der jeweiligen Module übernommen.

Das Ziel von Paket-Agenten ist dynamisch. Es wird von den Order-Agenten verwaltet. Kommt ein neuer Auftrag ins System, wird vom Order-Agenten, der den Auftrag verwaltet, eine Nachricht an das entsprechende Paket gesendet. Erhält der Paket-Agent eine solche Nachricht, wird dem Order-Agenten der Empfang bestätigt und das eigene Ziel wird angepasst.

Hat der Paket-Agent ein gültiges Ziel und wird ihm vom Plattform-Agenten per Flag die Erlaubnis erteilt, sendet er dem Routing-Agenten seiner Plattform eine Routing-Anfrage, bestehend aus dem Ziel des Pakets. Wenn diese nicht abgelehnt wird, wartet der Paket-Agent, bis sein Ziel geändert wird, oder er sich auf einer Plattform befindet, die nicht seinem aktuellen Ziel entspricht und er die erneute Erlaubnis bekommt, eine Routing-Anfrage zu stellen. Wird die Anfrage dagegen abgelehnt, stellt er beim nächsten Aufruf eine neue, bis die Anfrage vom Routing-Agenten angenommen wird.

Schließlich kann der momentane Zustand des Pakets über eine sogenannte \textit{UPDATE\_PHYSICAL}-Nachricht von einem Gateway abgefragt werden. Der Agent antwortet darauf mit der ID der Plattform, auf der er sich zur Zeit befindet und dem eigenen Ziel.
\subsubsection{Plattform-Agent}
Der Plattform-Agent ist der einzige plattformabhängige Agent des Systems. Während alle anderen Agenten auf allen Modultypen identisch sind, ist der Plattform-Agent modulspezifisch. Seine Aufgabe ist die Steuerung und Überwachung seines Moduls.

Beiden gemeinsam ist jedoch die Übertragung, also das Beenden und die erneute Initialisierung, von Paket-Agenten. Diese wird immer vom Volksbot initialisiert. Es wird eine Anfrage an den Plattform-Agenten der jeweiligen Rampe gesendet, entweder nach einem Lagerplatz oder nach einem speziellen Paket, abhängig davon, ob ein Paket abgelegt oder aufgenommen werden soll. Soll ein Paket abgelegt werden, muss die Anfrage bestätigt werden, bevor ein Registrierungs-Auftrag mit den Details des Paket-Agenten gesendet wird und der Agent auf seiner momentanen Plattform terminiert wird. Soll ein Paket aufgenommen werden, prüft die Rampe, ob das Paket mit der geforderten ID vorhanden ist und ausgegeben werden kann und sendet im Erfolgsfall ebenfalls einen Registrierungs-Auftrag und terminiert seinerseits den  entsprechenden Paket-Agenten, der dann auf dem Volksbot neu initialisiert wird.

Außerdem geben beide auf eine \textit{UPDATE\_PHYSICAL}-Nachricht die IDs aller Paket-Agenten zurück, die sich derzeit auf dem Modul befinden.

Im Folgenden werden nun die plattformspezifischen Eigenschaften der Plattform-Agenten beschrieben.

\paragraph{Plattform-Agent der Rampen}\mbox{}\\
Der Plattform-Agent auf einer Rampe ist neben der Verwaltung der Paket-Agenten auch für die Steuerung und das Auslesen der Bolzen über das Bolt\_Interface beziehungsweise Lichtschranken über das Photosensor\_Interface verantwortlich. Er sorgt dafür, dass die Pakete korrekt vereinzelt werden und verwaltet ihre Reihenfolge. Außerdem prüft er auf die Anfrage eines Volksbots, ein Paket abzulegen, anhand der Lichtschranken, ob noch ein Platz auf der Rampe zur Verfügung steht.
\paragraph{Plattform-Agent der Volksbots}\mbox{}\\
Der Plattform-Agent auf einem Volksbot kommuniziert mit dem Laptop, der den Volksbot steuert. Er erhält eine Nachricht, wenn der Volksbot seine Ziel-Position erreicht hat. Daraufhin initiiert er die Übergabe des Paketes. War die Übergabe des Paket-Agenten erfolgreich, sendet der dem Laptop eine Nachricht über die serielle UART-Nachricht, um das Fließband auf dem Volksbot zu starten und die physische Übernahme des Pakets zu starten.
\subsubsection{Order-Agent}
Die Order-Agenten übernehmen die Rolle eines zentralen Materialflussrechners im Materialflusssystem. Ihre Aufgabe ist die Verarbeitung von Aufträgen, sprich die Zuweisung von Zielen an Pakete. Aufträge bestehen aus Paket- und Ziel-ID und werden über ein Gateway in das System eingegeben. Dafür wird eine entsprechende Agenten-Nachricht an einen einzelnen Order-Agenten gesendet, der den Empfang bestätigt oder ablehnt, falls kein Platz in seinem Speicher zur Verfügung stand. In diesem Fall muss ein anderer Order-Agent mit dem Auftrag betraut werden. Ein Auftrag wird mit seiner Paket- und Ziel-ID sowie einem Status ("`zu bearbeiten"' beziehungsweise "`in Verteilung"') in einer Warteschlange ablegt.

Hat der Order-Agent in einem Aufruf keine Nachricht erhalten, durchsucht er diese Warteschlange nach zu bearbeitenden Aufträgen und sendet eine Nachricht an das entsprechende Paket, sein Ziel zu ändern. Wird der Empfang dieser Nachricht vom Paket bestätigt, wird der Auftrag gelöscht, von nun an ist das Paket für die Erreichung seines Ziels verantwortlich. Sind alle Aufträge in Verteilung muss davon ausgegangen werden, dass die entsprechenden Nachrichten nicht angekommen sind oder die Pakete noch nicht im System sind. Daher wird in diesem Fall der Status aller Aufträge zurückgesetzt und es wird erneut versucht, Nachrichten an die einzelnen Pakete zu senden.
\subsubsection{Routing-Agenten}

Die Routing-Agenten kümmern sich um die Wegplanung der Pakete im Materialflusssystem. Sie suchen nach einem Volksbot, der ein Paket möglichst günstig zu seinem Ziel bringen kann. Dafür führen sie untereinander eine Auktion durch, bei der ein Transportauftrag zu möglichst geringen Kosten an einen Volksbot vergeben wird. Ein Routing-Agent reagiert dabei auf die Routing-Anfrage eines Paket-Agenten. Ein Routing-Agent kann gleichzeitig nur an einer Auktion teilnehmen beziehungsweise diese initiieren. Hiermit wird verhindert, dass ein Routing-Agent gleichzeitig zwei Auktionen gewinnt und deshalb eine der Auktionen zurückgerollt und wiederholt werden muss.

Die Routing-Agenten werden als kommunizierende Zustandsautomaten implementiert. Zustandsübergänge können durch eingehende Nachrichten oder Timer ausgelöst werden. \autoref{fig:routing_agent_fsm} zeigt den zugrunde liegenden Automaten.

\begin{figure}[h!]
  \centering
    \includegraphics[width = 1.35\textwidth, angle=90]{flow/RoutingAgent_FSM.png}
    \caption{Zustandsautomat des Routing Agenten}
    \label{fig:routing_agent_fsm}
\end{figure}

Ein Routing-Agent startet stets in Zustand 0. In diesem Zustand wartet er auf eingehende Routing-Anfragen. Diese können entweder von Paketen auf der eigenen Plattform oder von anderen Routing-Agenten kommen. Sie unterscheiden sich im ersten Byte der Conversation-ID einer Agenten-Nachricht. Hier ist die Auktions-ID gespeichert, die für neue Routing-Anfragen von Paketen erst durch den Routing-Agenten bestimmt werden muss und daher auf 0 gesetzt ist. 

Bei Eingang einer Routing-Anfrage durch ein Paket wird eine neue Routing-Anfrage an alle Routing-Agenten versendet, ein Timer gestartet, der abläuft, wenn die Bearbeitungszeit erreicht ist, und in Zustand 3 übergegangen. Kommt die Anfrage von einem anderen Routing-Agenten prüft der Agent, ob das Ziel erreichbar ist. Für Module auf einem Volksbot ist dies immer wahr, für Module an Rampen immer falsch. Ist das Ziel erreichbar, wird eine UART-Nachricht an den Volksbot gesendet, der die Kosten der Fahrt vom anfragenden Routing-Agenten zum Ziel des Pakets berechnen soll. Anschließend geht der Automat in Zustand 1 über.

In Zustand 1 wartet der Agent auf die Antwort des Volksbots auf seine Kostenanfrage. Geht diese ein und sind die Kosten größer als null, bedeutet dies, dass das Ziel erreichbar ist. Der Agent sendet anschließend diese Kosten an den Initiator der Auktion und geht in Zustand 2 über, wo er auf die Antwort des Initiators wartet. Wird das Angebot bestätigt, wird der Volksbot beauftragt, sich zum Ausgang des Initiators zu bewegen und der Automat geht in Zustand 6 über. Wird die Anfrage abgelehnt, geht der Automat zurück in Zustand 0 und wartet auf neue Anfragen. In Zustand 6 wartet der Routing Agent auf eine Nachricht des Plattform-Agenten, der bestätigt, dass das Paket abgegeben wurde und neue Anfragen angenommen werden können.

In Zustand 3 wartet der Routing-Agent auf Angebote von anderen Routing-Agenten, nachdem er eine Routing-Anfrage für ein Paket auf der eigenen Plattform verschickt hat. Er speichert diese Angebote mit Absender-ID und Kosten. Läuft schließlich der Bearbeitungs-Timer ab, wird geprüft ob mindestens ein Angebot eingangen ist. Ist das der Fall, wird das beste Angebot bestimmt und der Agent geht in Zustand 4 über. Andernfalls wird ein neuer Timer gesetzt, bis die Anfrage wiederholt wird und der Agent geht in Zustand 5. In Zustand 5 wartet der Agent auf den Ablauf des Timers, versendet die Routing-Anfrage erneut an alle Routing-Agenten und geht zurück in Zustand 3. Zustand 4 dagegen bleibt aktiv, bis alle Teilnehmer der Auktion benachrichtigt wurden. In jedem Aufruf des Agenten wird eine Nachricht mit Cancel oder Acknowledge an einen weiteren Teilnehmer der Auktion gesendet. Sind alle Teilnehmer benachrichtigt, geht der Agent zurück in Zustand 0 und wartet auf neue Anfragen.
